// Generated by BUCKLESCRIPT VERSION 3.1.5, PLEASE EDIT WITH CARE
'use strict';

var Block = require("bs-platform/lib/js/block.js");
var Curry = require("bs-platform/lib/js/curry.js");
var React = require("react");
var Caml_array = require("bs-platform/lib/js/caml_array.js");
var Caml_int32 = require("bs-platform/lib/js/caml_int32.js");
var ReasonReact = require("reason-react/src/ReasonReact.js");
var Row$ReactTemplate = require("./Row.bs.js");
var Lane$ReactTemplate = require("./Lane.bs.js");
var WebAudio$ReactTemplate = require("./WebAudio.bs.js");

var component = ReasonReact.reducerComponent("App");

function applyToAllLanes(state, fn) {
  return /* Update */Block.__(0, [/* record */[
              /* octave */Curry._1(fn, state[/* octave */0]),
              /* transpose */Curry._1(fn, state[/* transpose */1]),
              /* velocity */Curry._1(fn, state[/* velocity */2]),
              /* isPlaying */state[/* isPlaying */3],
              /* scheduler */state[/* scheduler */4],
              /* soundBuffer */state[/* soundBuffer */5]
            ]]);
}

function applyToLane(state, laneValue, fn) {
  var tmp;
  switch (laneValue) {
    case 0 : 
        tmp = /* record */[
          /* octave */Curry._1(fn, state[/* octave */0]),
          /* transpose */state[/* transpose */1],
          /* velocity */state[/* velocity */2],
          /* isPlaying */state[/* isPlaying */3],
          /* scheduler */state[/* scheduler */4],
          /* soundBuffer */state[/* soundBuffer */5]
        ];
        break;
    case 1 : 
        tmp = /* record */[
          /* octave */state[/* octave */0],
          /* transpose */Curry._1(fn, state[/* transpose */1]),
          /* velocity */state[/* velocity */2],
          /* isPlaying */state[/* isPlaying */3],
          /* scheduler */state[/* scheduler */4],
          /* soundBuffer */state[/* soundBuffer */5]
        ];
        break;
    case 2 : 
        tmp = /* record */[
          /* octave */state[/* octave */0],
          /* transpose */state[/* transpose */1],
          /* velocity */Curry._1(fn, state[/* velocity */2]),
          /* isPlaying */state[/* isPlaying */3],
          /* scheduler */state[/* scheduler */4],
          /* soundBuffer */state[/* soundBuffer */5]
        ];
        break;
    
  }
  return /* Update */Block.__(0, [tmp]);
}

function make() {
  return /* record */[
          /* debugName */component[/* debugName */0],
          /* reactClassInternal */component[/* reactClassInternal */1],
          /* handedOffState */component[/* handedOffState */2],
          /* willReceiveProps */component[/* willReceiveProps */3],
          /* didMount */(function (self) {
              Curry._2(WebAudio$ReactTemplate.loadSound, "harp.mp3", (function (buffer) {
                      self[/* state */1][/* soundBuffer */5][0] = /* Some */[buffer];
                      return /* () */0;
                    }));
              self[/* state */1][/* scheduler */4][0] = /* Some */[WebAudio$ReactTemplate.createSchedule((function (beatTime, beatLength) {
                        return Curry._1(self[/* send */3], /* Playback */Block.__(0, [
                                      beatTime,
                                      beatLength
                                    ]));
                      }))];
              return /* () */0;
            }),
          /* didUpdate */(function (param) {
              var newSelf = param[/* newSelf */1];
              if (param[/* oldSelf */0][/* state */1][/* isPlaying */3] !== newSelf[/* state */1][/* isPlaying */3]) {
                var match = newSelf[/* state */1][/* scheduler */4][0];
                if (match) {
                  var scheduler = match[0];
                  if (newSelf[/* state */1][/* isPlaying */3]) {
                    Curry._1(newSelf[/* send */3], /* ResetLanes */1);
                    return Curry._1(scheduler[/* start */0], /* () */0);
                  } else {
                    return Curry._1(scheduler[/* stop */1], /* () */0);
                  }
                } else {
                  return /* () */0;
                }
              } else {
                return 0;
              }
            }),
          /* willUnmount */component[/* willUnmount */6],
          /* willUpdate */component[/* willUpdate */7],
          /* shouldUpdate */component[/* shouldUpdate */8],
          /* render */(function (self) {
              var match = self[/* state */1][/* isPlaying */3];
              return React.createElement("div", {
                          className: "ma4"
                        }, React.createElement("button", {
                              className: "w4",
                              onClick: (function () {
                                  return Curry._1(self[/* send */3], /* SetPlayback */Block.__(2, [!self[/* state */1][/* isPlaying */3]]));
                                })
                            }, match ? "Stop" : "Play"), ReasonReact.element(/* None */0, /* None */0, Row$ReactTemplate.make("Octave", self[/* state */1][/* octave */0], (function (index, value) {
                                    return Curry._1(self[/* send */3], /* SetLaneValue */Block.__(3, [
                                                  /* Octave */0,
                                                  index,
                                                  value
                                                ]));
                                  }), (function (index) {
                                    return Curry._1(self[/* send */3], /* SetLoopAfterIndex */Block.__(1, [
                                                  /* Octave */0,
                                                  index
                                                ]));
                                  }), /* array */[])), ReasonReact.element(/* None */0, /* None */0, Row$ReactTemplate.make("Transpose", self[/* state */1][/* transpose */1], (function (index, value) {
                                    return Curry._1(self[/* send */3], /* SetLaneValue */Block.__(3, [
                                                  /* Transpose */1,
                                                  index,
                                                  value
                                                ]));
                                  }), (function (index) {
                                    return Curry._1(self[/* send */3], /* SetLoopAfterIndex */Block.__(1, [
                                                  /* Transpose */1,
                                                  index
                                                ]));
                                  }), /* array */[])), ReasonReact.element(/* None */0, /* None */0, Row$ReactTemplate.make("Velocity", self[/* state */1][/* velocity */2], (function (index, value) {
                                    return Curry._1(self[/* send */3], /* SetLaneValue */Block.__(3, [
                                                  /* Velocity */2,
                                                  index,
                                                  value
                                                ]));
                                  }), (function (index) {
                                    return Curry._1(self[/* send */3], /* SetLoopAfterIndex */Block.__(1, [
                                                  /* Velocity */2,
                                                  index
                                                ]));
                                  }), /* array */[])));
            }),
          /* initialState */(function () {
              return /* record */[
                      /* octave */Lane$ReactTemplate.emptyLane(0),
                      /* transpose */Lane$ReactTemplate.emptyLane(0),
                      /* velocity */Lane$ReactTemplate.emptyLane(100),
                      /* isPlaying */false,
                      /* scheduler */[/* None */0],
                      /* soundBuffer */[/* None */0]
                    ];
            }),
          /* retainedProps */component[/* retainedProps */11],
          /* reducer */(function (action, state) {
              if (typeof action === "number") {
                if (action === 0) {
                  return applyToAllLanes(state, Lane$ReactTemplate.advance);
                } else {
                  return applyToAllLanes(state, Lane$ReactTemplate.reset);
                }
              } else {
                switch (action.tag | 0) {
                  case 0 : 
                      var beatTime = action[0];
                      var match = state[/* soundBuffer */5][0];
                      if (match) {
                        var buffer = match[0];
                        return /* SideEffects */Block.__(1, [(function (self) {
                                      var octave = Caml_array.caml_array_get(self[/* state */1][/* octave */0][/* values */0], self[/* state */1][/* octave */0][/* index */1]);
                                      var transpose = Caml_array.caml_array_get(self[/* state */1][/* transpose */1][/* values */0], self[/* state */1][/* transpose */1][/* index */1]);
                                      var velocity = Caml_array.caml_array_get(self[/* state */1][/* velocity */2][/* values */0], self[/* state */1][/* velocity */2][/* index */1]);
                                      var note = Caml_int32.imul(octave, 12) + transpose | 0;
                                      var gain = velocity / 100;
                                      Curry._6(WebAudio$ReactTemplate.playBuffer, buffer, note, gain, beatTime, 0, 1);
                                      return Curry._1(self[/* send */3], /* AdvancePlayback */0);
                                    })]);
                      } else {
                        return /* NoUpdate */0;
                      }
                  case 1 : 
                      var index = action[1];
                      return applyToLane(state, action[0], (function (subState) {
                                    return /* record */[
                                            /* values */subState[/* values */0],
                                            /* index */subState[/* index */1],
                                            /* visualIndex */subState[/* visualIndex */2],
                                            /* loopAfterIndex */index
                                          ];
                                  }));
                  case 2 : 
                      return /* Update */Block.__(0, [/* record */[
                                  /* octave */state[/* octave */0],
                                  /* transpose */state[/* transpose */1],
                                  /* velocity */state[/* velocity */2],
                                  /* isPlaying */action[0],
                                  /* scheduler */state[/* scheduler */4],
                                  /* soundBuffer */state[/* soundBuffer */5]
                                ]]);
                  case 3 : 
                      var value = action[2];
                      var index$1 = action[1];
                      return applyToLane(state, action[0], (function (subState) {
                                    Caml_array.caml_array_set(subState[/* values */0], index$1, value);
                                    return subState;
                                  }));
                  
                }
              }
            }),
          /* subscriptions */component[/* subscriptions */13],
          /* jsElementWrapped */component[/* jsElementWrapped */14]
        ];
}

var maxVelocity = 100;

exports.maxVelocity = maxVelocity;
exports.component = component;
exports.applyToAllLanes = applyToAllLanes;
exports.applyToLane = applyToLane;
exports.make = make;
/* component Not a pure module */
